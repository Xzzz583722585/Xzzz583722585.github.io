

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Jon Xzzz">
  <meta name="keywords" content="">
  
  <title>DDD-001-对一个未完成项目的总结 - Jon Xzzz</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"www.jonxzzz.xyz","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Jon Xzzz</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="DDD-001-对一个未完成项目的总结">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-08-19 19:51" pubdate>
        2021年8月19日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      7.3k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      74
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">DDD-001-对一个未完成项目的总结</h1>
            
            <div class="markdown-body">
              <h1 id="DDD-001-对一个未完成项目的总结"><a href="#DDD-001-对一个未完成项目的总结" class="headerlink" title="DDD-001-对一个未完成项目的总结"></a>DDD-001-对一个未完成项目的总结</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文内容为ZXJY公司内部系统架构、代码、文章、讨论的归纳总结，以及本人对各问题的思考。因保密相关，涉及到敏感内容，会以网络普遍讨论的模型为例。</p>
<h2 id="ZXJY公司系统架构所面临的问题"><a href="#ZXJY公司系统架构所面临的问题" class="headerlink" title="ZXJY公司系统架构所面临的问题"></a>ZXJY公司系统架构所面临的问题</h2><p><strong>核心问题：微服务数量过多。</strong></p>
<p>ZXJY从2015年开始全面使用微服务架构后，服务的数量就开始飞涨。某些研发组甚至发展到了，一个业务功能一个微服务的程度（往往是按照数据库表来划分的，这里要埋一个坑，即微服务如何划分的实践问题）。在一开始感受到微服务带来的分工和模块化的优点之后，团队很快就碰到如何管理数量庞大的微服务的棘手问题–<strong>系统复杂程度指数级上升</strong>。</p>
<ul>
<li><p>理解困难。</p>
<ul>
<li>新人对业务逻辑与代码逻辑的映射、系统架构、代码细节、技术实现理解困难。</li>
</ul>
</li>
<li><p>开发困难。</p>
<ul>
<li>难以判断新功能放在哪个微服务更合适（或者说都可以）。</li>
<li>抽象泄漏。微服务作为SOA的一种类型，其初衷就是希望能够通过对外部提供一个合理抽象的接口，从而屏蔽内部的实现。只要接口定义不变，内部可以独立迭代，从而实现开发流程的扩展性。然而我们很难保证服务拆分和接口设计是合理的，尤其在业务快速迭代的过程中，整个系统的各种基础假设都会被持续迭代。然而一旦某个逻辑被暴露为微服务接口，其抽象就泄露到了整个系统，后续要修改或者下线这个接口的成本是极高的。这就导致了后续即使业务逻辑发生变化，我们也只能捏着鼻子在沿着错误的抽象来修修补补。</li>
</ul>
</li>
<li><p>部署困难。</p>
<ul>
<li>一个功能的上线可能涉及到多个微服务，那么怎么打包、上线顺序等等都是问题，当团队开发节奏加快后，频繁的部署使研发、运维人员苦不堪言，很多简单的修改都需要同时更新多个微服务，不但使得工作量大大增加，也使得部署的依赖更加复杂。</li>
<li>DevOps、敏捷等技术的运用遭受挑战。</li>
</ul>
</li>
<li><p>测试困难。</p>
<ul>
<li>本地代码调试困难。</li>
<li>Bug溯源、定位、追踪复杂。</li>
</ul>
</li>
<li><p>维护困难。</p>
<ul>
<li>网络波动对服务性能影响巨大。</li>
<li>对基础设施迭代不友好。数量庞大的微服务大大拖慢了基础设施迭代和推广的速度，又进一步使得微服务无法得到有效支撑。一个惨痛的现实就是，每次有紧急的基础设施升级，都必须手动升级数量庞大的微服务，带来了巨大的人力浪费。</li>
</ul>
</li>
</ul>
<h2 id="衡量指标"><a href="#衡量指标" class="headerlink" title="衡量指标"></a>衡量指标</h2><p>在讨论解决方案之前，应先定义清楚系统架构所看重的指标都有哪些（此处不由得联想到《演进式架构》，或者更广义的说，在讨论任何科学问题时，先行定义清楚问题域是至关重要的）。</p>
<p>在介绍最终衡量指标前，先对陶文的博客《代码防腐》<a target="_blank" rel="noopener" href="https://github.com/taowen/modularization-examples/blob/master/docs/Part1/README.md">^ 陶文 《代码防腐》</a>做简要陈述。代码腐败也叫软件熵，是指软件性能随着时间而逐渐恶化或反应性的递减，导致软件出错、不稳定。这并不是一个物理现象，因为软件实际上并不会衰变，而是缺乏敏捷反应、未能随环境变化而修改<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%BD%AF%E4%BB%B6%E8%85%90%E8%B4%A5">^ 代码腐败</a>。显然，正如《没有银弹》一文所说，由于软件本质性<a href="%E8%BD%AF%E4%BB%B6%E6%9C%AC%E8%BA%AB%E5%9C%A8%E6%A6%82%E5%BF%B5%E5%BB%BA%E6%9E%84%E4%B8%8A%E5%AD%98%E5%85%88%E5%A4%A9%E7%9A%84%E5%9B%B0%E9%9A%BE%EF%BC%8C%E4%BA%A6%E5%8D%B3%E5%A6%82%E4%BD%95%E4%BB%8E%E6%8A%BD%E8%B1%A1%E6%80%A7%E9%97%AE%E9%A2%98%EF%BC%8C%E5%8F%91%E5%B1%95%E5%87%BA%E5%85%B7%E4%BD%93%E6%A6%82%E5%BF%B5%E4%B8%8A%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%82">^ 软件本质性</a>所引发出的 complexity、invisibility、conformity、changeability，再加上许多人为因素：软件开发者本人所处时空限制、能力限制导致其并不能做出现在看来“完美”的设计；商业软件本身需要去衡量各种成本，包括资金、人力、时间等等；缺乏完善的测试。以上因素，导致开发者不得不在本就困难的问题基础上，缺乏思考、设计的情况下赶工开发，致使问题影响范围扩大，又由于没有严格的测试拦截，导致问题得不到有效的反映和遏制，再加之时候缺乏复盘性的总结学习，导致问题越来越难以解决，即腐败的味道愈加浓重。</p>
<p>什么样的系统是我们所希望的，我们又要如何去发现代码腐败。</p>
<p>首先陶文指出了三点系统应该具备的特性，现做出总结。</p>
<ul>
<li><p>Autonomy 独立性。</p>
<p>开发团队担心出现这样的症状：</p>
<ul>
<li>沟通多：做新需求很难，因为需要牵涉到很多的团队，要和大量的人去沟通才能把需求落地。</li>
<li>需求做了就删不掉：一旦需求做进去了之后，即便愿意把这个功能下线也非常困难。遗留代码日积月累。</li>
</ul>
<p>独立性的愿景就是尽量减轻上述的症状，让拆分出来的代码更独立。从而新需求需要的沟通可以更少，不需要的功能也可以比较容易被干掉。用以下指标衡量系统的独立性：</p>
<ul>
<li>会议时间。</li>
<li>接口改动/实现改动 比率：接口如果比实现要小很多的话，接口被修改相对于实现被修改的概率也就小了很多。这样我们大部分时候就可以只改实现，而不改接口。</li>
</ul>
</li>
<li><p>Consistency 一致性。</p>
<p>一致性是对可复用 Git 仓库的要求，是为了防御常见的设计错误。用以下指标衡量系统的一致性：</p>
<ul>
<li>必要参数总量/参数总量 比率：把可复用Git仓库对外提供的函数的参数分为两类，必要参数和非必要参数。非必要参数是指只有 10% 的调用方传递了的参数。</li>
<li>咨询量：可复用的 Git 仓库，应该努力降低使用者的成本。 使用者的最大成本来自于沟通问询。如果文档不清楚，接入方式是手工的，必然会体现在咨询量上。</li>
<li>接入次数：使用次数只有1次或者2次，就不应该被抽取成可复用的 Git 仓库。至少要被使用3次。</li>
<li>接入率：如果要抽出可复用的代码，出发点应该是一致性，是在团队关键成员达成了一致之后的有意识行为。</li>
<li>阻断率：阻断率指所有可接入的地方，有多少处上了强制检查，确保了违规行为会被阻断。</li>
</ul>
</li>
<li><p>Feedback 反馈性。</p>
<p>开发团队担心出现这样的症状：</p>
<ul>
<li>故障定位慢。</li>
<li>获得真实反馈慢：代码写完了要等审核发版，错过了这个版本又要等一个月公司才会发下个版本。</li>
<li>本地测试难：稍微有点价值的测试都不是本地可以用 JUnit 写出来的。</li>
<li>听不见炮火：管你前线洪水滔天，我这后台模块是管不着的。</li>
</ul>
<p>反馈性的愿景是尽量减少获得反馈的摩檫力。业务逻辑拆分为什么会影响到反馈性呢？这仍然是要归结为人的沟通效率问题（《人月神话》）。能用标准化的方式解决的，就可以减少沟通。能尽量减少信息传递次数的，就可以有效减少传递过程中的信息衰减。用以下指标衡量系统的反馈性：</p>
<ul>
<li>工单流转时长。</li>
<li>故障定位时长。</li>
<li>代码集成时长。</li>
</ul>
</li>
</ul>
<p>其次陶文给出了应对代码腐败的策略。</p>
<ul>
<li><p>信息隐藏：封装、抽象、依赖倒置。</p>
<p>从独立性的角度来说，使用 UI 做为接口，比使用数据做为接口更能自主变化。 因为展示细节变了，拿 UI 做为接口的情况，接口大概率是不需要修改的。 除非展示需求正好改的是界面布局这样的大尺度上的东西。</p>
<p>在使用依赖倒置的情况下，接口需要显式地提炼出来，并有意去最小化接口部分。 从而可以让更多的需求改动封闭在更上层的依赖关系里完成，更多去改实现代码，而不是改接口代码。</p>
<p>拿UI做接口，依赖倒置，目的都是让接口改得少。从而使得跨团队的沟通量变小，提高独立性。</p>
<p>对比“数据集成”和“责任链加工界面”，两个的区别在于是否易于判断一个新需求该改谁。</p>
<p>在数据集成的实现方式里，业务API是无所不能的，大部分需求都可以改业务API，也可以去改限时折扣这些Git仓库。 这就导致需要依赖 code review，人肉确保没有把所有的业务逻辑都堆砌到最顶层的业务模块里。</p>
<p>责任链加工界面，其接口是显式定义的 Cart 和 calculateCart。 每个具体的业务都是直接返回的 Cart，而不依赖于业务 API 的二次翻译。 所以相对来说，calculateCart 里可以只放必要的规则互斥之类的逻辑，而不需要太关心什么数据放界面哪个位置这样的事情。 这样做更容易在改业务逻辑的时候判断应该改哪个 Git 仓库。 Code Review 也可以把注意力主要放在 Cart 和 calculateCart 的修改是否是必要的上。</p>
<p>关键问题是，如何做到独立性，这里不能依靠人力的code review，应该依赖代码结构，限制改动范围</p>
<p>中台的出现，不是为了复用，减少新业务的软件开发成本。软件开发能有多少成本，或者说能省多少成本。 不是因为我们认为需求都差不多，可以归纳出可复用的预制件，然后沉淀到中台去。 中台的本质是为了让上面这样的深度整合的需求因为集中到一个部门能做得更快一些。这种类型的需求也许是有中国特色的。 与传统企业财务集中那样的离线整合不同，这里的集成需求需要是在线，深入参与客户交互体验过程之中的。 如果让主界面被任意一个业务所全部独占，其他业务与其合作就阻力会更大一些。 “收口”到中台可以方便业务之间实现稀缺资源的共享（分配，撕逼），也方便业务之间的互联互通，减少适配成本。</p>
<p>中台部门自称自己是 Software Product Line，提供了一堆预制件以及装配用的 DSL，能加速新业务的快速上线与试错。 CTO 希望中台是 Central Platform 削平内部的山头，打通数据和权限的利器。 实际不小心落地成了 Middle Office（Middle 衙门），只要从此过，留下买路财的官僚机构。</p>
<p>在这样的依赖关系下，插件的 Git 仓库是不会造成全局的影响的。这样我们就可以放心的把新人分配去写一个独立的插件，而不用担心其设计选择造成大面积的代码腐化。Code Review 仅需要集中关照主板。并且评价“高内聚低耦合”的标准也可以用主板的代码行数进行量化（在完成需求的前提下，主板的代码行数越少就是越好）。</p>
</li>
<li><p>持续改进</p>
<p>是的，需求是不可预测的，不要基于臆想的需求提前设计。我们不需要提前设计，但是要基于共识进行分工。</p>
<p>只对自己写的代码负责要体现在发布变更，告警定位这两个环节里。</p>
<ul>
<li><p>发布变更</p>
<p>单体应用最大的原罪就是变更的粒度太大了。而大粒度变更是稳定性的最大敌人。 切分变更有三种主要的做法：</p>
<ul>
<li><p>多进程：把单体进程切分成多进程。一次只变更其中的一个。因为大部分线上故障都是由变更引起的，所以SRE会非常强调部署流程的小心谨慎。 一旦发现有问题，就会被要求立即回滚。这也就导致了搭车上线是非常讨厌的事情，谁知道你搭车进来的改动会不会翻车。 所以拆分成多进程，各上各的就会变成非常强烈的需求。</p>
<p>但是用拆分进程的方式来解决上线慢的问题也会有一些缺点：</p>
<ul>
<li>反馈不集中：小流量的时候，引起的小规模的故障可能观察不出来</li>
<li>灰度数有限：集群规模比较小的时候，总共就几个进程，灰度的刻度就会很大</li>
<li>回滚慢：进程替换需要时间</li>
<li>灰度时间有限：上线观察一天已经很夸张了，要更长时间的观察是不好用上线的方式来实现的</li>
<li>上线顺序：进程之间经常有数据依赖，并不能总是保持向后兼容。当要同时升级多个进程的时候，上线顺序的确定是比较头疼的事情</li>
</ul>
</li>
<li><p>多租户：把所有的业务数据分成租户。一次只升级一个租户的数据和代码。租户是业务相关的概念。 这意味着开源社区是不能给你现成的基础设施的，所有的多租户功能都需要自研。</p>
</li>
<li><p>多变种：分租户还是粒度太粗了，比如说挂掉一个城市也是不可接受的。那么可以在线上同时运行多个版本的代码，然后逐步的切流量。在不改变进程的情况下，通过配置等方式更灵活地进行装配组合。这样发布和上线就可以解开为两个操作了。上线就是上线，改变进程里的可执行代码。 上线可以不把 Feature Flag 打开，而是保持原有的行为。 然后再慢慢地打开 Feature Flag 的流量开关。</p>
</li>
</ul>
<p>当然更极致的做法是同时分租户，也在租户升级的时候切流量。</p>
<ul>
<li>多进程：控制的是代码的变更</li>
<li>多租户：控制的是数据的变更</li>
<li>多变种：控制的是配置的变更</li>
</ul>
</li>
<li><p>告警定位</p>
<p>业务逻辑无论如何做拆分，最终仍然是要跑起来，集成到一起去的。 无论是编辑时拆分成文件、文件夹、Git仓库，还是运行时拆分成进程，拆分无可避免地引入了“降低反馈速度”的副作用。 一旦产生了分工，就会有你不了解的部分。这也是分工的本意所在，控制知识边界，让普通人也可以参与劳动。 但是软件是要整体集成到一起才能发挥其全部价值。这种“整体”与“部分”的矛盾，造成了Feedback问题。</p>
<p>要减轻分工带来的负面影响，最重要的是做好“甩锅”。 换句话说就是要做好“隔离”，虽然我们把所有的部件都集成到了一起了，但是我们仍然要在“运行时”通过各种手段人为制造出边界，把责任隔离出来。 把责任隔离出来，就是把运行时的行为，与背后负责的团队与个人对应起来。</p>
<ul>
<li><p>进程边界</p>
<p>把不同的 Git 仓库跑在不同的进程里。这样只要看是哪个进程出的问题，就可以知道是由哪个 Git 仓库引起的了。 进程边界有如下的好处：</p>
<ul>
<li>完善的跨进程调用监控：相比进程内调用，跨进程调用的监控基础设施要完善得多。因为处理的数据量要小得多。</li>
<li>操作系统强制的配额和安全性：就是基础设施更好。都是提前做好，而且充分测试的。</li>
<li>隔离的内存状态：进程之间不会共享内存，不会因为共享内存而产生逃逸监控的影响。</li>
</ul>
<p>进程的缺点如下</p>
<ul>
<li>适用场景：在前端里启动独立的进程不是常规的做法。</li>
<li>性能优化会漏掉依赖：经常我们会把配置等数据读取一次之后就缓存在进程内。这部分依赖就很容易逃逸出监控的范围。</li>
<li>远离用户：拆分出来的进程往往是越来越靠后台，离用户越远，就越难以倾听到用户的声音。</li>
</ul>
<p>我们的目标是在出问题之后，能从运行时的现象找到对应的Git仓库。但是这个目标真的一定需要使用进程做边界么？</p>
</li>
<li><p>函数边界</p>
<p>同步调用栈、异步调用栈、组建树。无论是编程语言原生支持的同步调用栈，还是需要自研的异步调用栈，组件树，其目的都是隔离。 隔离就是给caller/callee 关系<strong>建索引</strong>，在找问题的时候尤其有用。</p>
</li>
<li><p>插件边界</p>
<p>如果有强制的插件规范，那甚至可以做到“内存状态”的隔离，用编译检查等手段禁止全局变量，禁止偷偷地访问另外一个插件的内部状态。 一个进程要读取一份配置，只有第一次RPC的时候我们才能监控到，后续缓存在内存里的访问就是不可见的了。 而插件则不用担心跨插件调用的开销，我们可以把配置缓存在另外一个插件里，这样每次读取配置都是跨插件的调用，从而可以被监控到。</p>
<p>插件和进程的核心区别就是插件可以适用于更多的运行时（比如iOS，微信小程序），可以用于拆分运行时调用关系更频繁更紧密的界面和流程。 进程边界的优势来自于社区共识，提前提供了大量开源的优秀基础设施。 但是并不意味着，除了进程边界，我们不能在进程内再为每个 git 仓库划出边界来，只是要付出一些自研代价罢了。 社区共识是不够的，在函数边界（特别是同步调用栈之外的其他调用关系），以及插件边界上都没有足够强的规范。 只要能在公司或者部门级别建立好共识，函数边界和插件边界完全可以满足问题定位的需求，甚至比进程边界做得更好。</p>
</li>
</ul>
</li>
</ul>
<p>微服务的拆分，其实就等价于Git仓库的拆分，也就是 Autonomy 章节中讨论的问题，怎么拆团队拆Git仓库的问题。 其主旨原则就一条：拆分之后，接口的定义要稳定，不要天天修改，导致频繁的跨团队强协作。所以 <a target="_blank" rel="noopener" href="https://github.com/taowen/modularization-examples/blob/master/docs/Part1/AutonomyMetrics.md">Autonomy</a> 优先，<a target="_blank" rel="noopener" href="https://github.com/taowen/modularization-examples/blob/master/docs/Part2/FeedbackMetrics.md">Feedback</a> 的问题，交给基础架构部门通过改进基础设施来解决。</p>
</li>
<li><p>分层</p>
<p>Consistency 和 Reuse 的出发点是不同的。 我对这两个词的感觉是，Reuse 是从所有代码中找重复，然后努力抽取出可复用的东西。 Consistent 则是我先定义了一个标准，比如说UI规范，然后强制要应用到所有的页面上。如果没有应用上，那就得说明理由，引入的不一致是有意为之，还是偶然的设计失误。 Consistent 隐含了先有共识（Consensus）的含义，就是产品和开发团队达成了什么是必须一致必须复用的共识。 而 Reuse 总有开发团队一厢情愿的意味在里面，依赖了每个人做新需求的时候去主动地消除重复。</p>
</li>
</ul>
<p><strong>现给出ZXJY公司对于系统的衡量指标。</strong></p>
<ul>
<li>整体的rpc接口数量</li>
<li>涉及rpc接口的修改次数占整体修改的比例。</li>
<li>微服务依赖关系的数量</li>
<li>一次需求平均所需修改的仓库数量</li>
<li>一个需求上线所需的时间</li>
<li>依赖：依赖和耦合的最大区别在于，当我们说“A和B耦合”时，在字面含义中，A和B二者平等。然而，正确的模块关系根本不应该平等，而应该是单向依赖才对。所以我们应该说“A依赖B”，这样含义要清楚得多。A依赖B意味着，A模块可以调用B模块暴露的API，但B模块绝不允许调用A模块的API。单向依赖是红线，好的设计一定不会违反这条红线。</li>
<li>正交性：指一个模块提供的API中，多个方法之间是否有重复的功能。</li>
<li>紧凑性：指一个模块提供的API中，公有方法总数必须很少，每个方法的参数也必须很少。</li>
</ul>
<p>业务逻辑可以被拆分成：</p>
<ul>
<li>编辑时：拆分成文件、文件夹、Git仓库</li>
<li>运行时：拆分成进程</li>
</ul>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p><strong>核心思路：降低微服务数量</strong>（好似说了一句白话）。</p>
<p>为了更好的管理系统的复杂度，减缓系统的腐化，我们的架构目标主要是：</p>
<ul>
<li><p>服务接口的合理与简单 高于 具体功能实现的优雅。系统复杂度主要来自于服务对外的接口，因此我们的架构重点关注接口设计，而内部实现可以相对灵活。</p>
</li>
<li><p>易于迭代 高于 强大的预先设计。当前业务灵活多变而团队经验较为欠缺，很难做好太多预先设计，但系统必须具备快速迭代的能力。</p>
</li>
<li><p>团队和系统的自治 高于 功能复用。功能复用很容易带来沟通成本上升、抽象泄露、以及功能分化的风险。</p>
</li>
<li><p>风格的简单一致 高于 追求技术完美。choose boring technology，控制工程风险。</p>
</li>
<li><p>工具和自动化高于灵活与精确。我们希望尽可能的利用工具和自动化来阻断不合理的设计，降低对人的依赖。</p>
</li>
</ul>
<p><strong>核心方案：区分“项目”和“服务”。一个项目对应一个代码仓库（git repo），规模可以适当大一些，应当包含一个领域内的大部分逻辑。一个服务对应一个运行时，可以是项目中的一个module或者是一个单独的entrypoint。基础架构的部署系统提供了便于部署项目的能力，即项目中的代码修改之后，可以自动部署所有关联的服务。</strong></p>
<p>微服务架构最大的好处是给出了非常清晰的模块边界。以前我们会让一个微服务来对应一个功能模块，导致粒度非常细。问题在于随着业务的变化，边界也是会随之变化的，如果我们过早通过微服务来实现边界，后续修改的成本是极高的。因此我们不应该再轻易独立出微服务，而是尽量在服务内部划分清晰的功能边界。我们要确定一种方式来实现服务内对于功能模块的隔离，在清晰边界和灵活迭代中找到平衡。</p>
<ul>
<li><p>目录分隔。</p>
<p>很自然的方案，就是把同一功能特性的代码组织成一个目录。当然目录下还可以根据层次来继续划分。这种方式还是能够让结构变的清晰一些的，但是</p>
<ol>
<li>目录的约束还是太薄弱了，很难真正理清依赖关系。</li>
<li>目录组织本身不太有一致的规范。</li>
</ol>
<p>还好有一些工具可以更加严格的强制目录隔离，比如ArchUnit，就可以通过单元测试来限制目录之间的各种依赖关系，从而确保功能的隔离。</p>
</li>
<li><p>Maven的module。</p>
<p>如果我们使用module来对应一个功能模块的话，是非常明确的隔离。如果采用这种方案，那就是每个功能对应一个module，server再引入其他的module来对外提供接口。开发中必须在pom里显示加入依赖关系，才能够调用其他模块，这是非常好的性质。</p>
<p>也有一些不太舒服的地方，就是偏公用的内容，必须定义在一个最基础的module之中，才能让大家共享。另外这种方式需要发布很多的子module，也增加了一些负担。此外，module之间要定义依赖关系的粒度比较大，只能限制整个module，如果要定义更细粒度的依赖规则（比如不能跨模块依赖storage）就无能为力了。因此目前我们还是更倾向使用目录分隔的方案。</p>
</li>
</ul>
<p>目前我们的服务架构都是遵照 三层架构，基本分为 展示层/逻辑层/存储层，每一层内没有更多划分模块的规范。因为我们把系统功能拆分成为多个微服务，而且之前我们的实践中往往把微服务拆的过小，因此一般逻辑都比较简单，每一层内不隔离问题也不大。不过之后每个微服务要处理相对完整的业务逻辑，粒度会变大，因此趋势上单个服务的复杂度会上升。因此简单的按层次来划分目录结构已经不够，此时的最佳实践应当是根据功能来划分。</p>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><h2 id="优缺点对比"><a href="#优缺点对比" class="headerlink" title="优缺点对比"></a>优缺点对比</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li><p>微服务数量变少之后，可以很大程度上改善上面提到的抽象泄露的问题，一个领域内的逻辑可以尽量保持在一个项目内部，不需要对外暴露内部接口。</p>
</li>
<li><p>在我们的基础设施足够强悍之前，微服务的数量变少总是可以大大的方便各种基础库的迭代。</p>
</li>
<li><p>项目内部的调用不需要过rpc，可以充分利用IDE的自动化重构能力，在运行效率和开发效率上都会有明显提升。</p>
</li>
<li><p>项目足够自治，对外部依赖较少，更加便于自动化测试。</p>
</li>
<li><p>只有确实跨领域的逻辑才需要对外暴露接口，对于这些接口也可以进行更严格的review。我们一直说code review重点应当关注接口的设计而非具体实现，如果微服务数量和拆分相对合理，我们应当期望微服务对外接口的变动是相对少的<a target="_blank" rel="noopener" href="https://github.com/taowen/modularization-examples">^陶文</a>。这样我们可以强制要求所有涉及到接口变动的修改应当有更加严格的review流程，从而保证系统设计的合理性。而微服务内部的变动其实可以相对灵活，因为重构和测试的成本都是较小的。</p>
</li>
<li><p>更易于消除循环依赖。</p>
</li>
<li><p>服务这一层抽象不是为了解决功能的划分，但是提供了两个益处：</p>
<ul>
<li>不同服务对应独立进程，提供了一定的运行时隔离，也便于单独扩容</li>
<li>一些展示层的代码可以放在上层模块中，使得模块之间容易避免循环依赖</li>
</ul>
<p>虽然不同服务对应了不同的进程，但是因为底层逻辑和存储都是共享的，因此只是提供了非常有限的隔离性。新建和删除服务的成本相对较低，但是每个服务都需要单独的部署，因此服务拆分也不宜太细。</p>
</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>仓库规模更大，打包、编译、自动化测试等步骤可能更加耗时，一次部署涉及的服务数量会更多。虽然对于单个仓库的操作效率会降低，但是减少了一次需要所涉及的仓库数量，所以整体效率应该还是提升的。</li>
<li>多人开发同一仓库的情况变的更加严重，修改冲突的机会变大。大部分的修改应该是局限在一个module内部，甚至module内的一个package内部，通过限制大家的修改范围，可以很大程度上避免冲突。</li>
<li>因为迭代是以项目为单位，中间的某些稳定模块也会因为其他模块的更改而多次部署。理论上基础架构的改进应当使得部署本身更加轻松和稳定，不会影响到整个系统的稳定。</li>
</ul>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Domain-Driven-Design/">Domain Driven Design</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/08/19/GO-GO-GO/">
                        <span class="hidden-mobile">GO!GO!GO!</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  
  <!-- 备案信息 -->
  <div class="beian">
    <span>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
        京ICP证123456号
      </a>
    </span>
    
      
        <span>
          <a
            href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12345678"
            rel="nofollow noopener"
            class="beian-police"
            target="_blank"
          >
            
              <span style="visibility: hidden; width: 0">|</span>
              <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
            
            <span>京公网安备12345678号</span>
          </a>
        </span>
      
    
  </div>


  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
